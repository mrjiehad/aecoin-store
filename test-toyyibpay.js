// Test script for ToyyibPay integration
// Run with: node test-toyyibpay.js

const { ToyyibPayGateway } = require('./src/lib/gateway/toyyibpay.ts');

async function testToyyibPay() {
  console.log('🧪 Testing ToyyibPay Integration...\n');

  // Initialize ToyyibPay gateway with your credentials
  const toyyibpay = new ToyyibPayGateway(
    '72pw4zkj-86r9-n9mg-mnle-ssimi08h74z8', // Your secret key
    'mmsixvz8' // Default category code
  );

  // Test 1: Create a bill
  console.log('📝 Test 1: Creating a ToyyibPay bill...');
  try {
    const billResult = await toyyibpay.createBill({
      orderNumber: 'TEST-' + Date.now(),
      amount: 6000, // RM 60.00 in cents
      currency: 'MYR',
      description: '500 AECOIN Package - Test Order',
      customerName: 'Test Customer',
      customerEmail: 'test@example.com',
      returnUrl: 'http://localhost:5173/success?test=true',
      callbackUrl: 'http://localhost:5173/api/webhook/toyyibpay'
    });

    if (billResult.success) {
      console.log('✅ Bill created successfully!');
      console.log('📄 Bill Code:', billResult.data.billCode);
      console.log('🔗 Payment URL:', billResult.data.billPaymentUrl);
      console.log('💡 You can visit the payment URL to test the payment flow.\n');
      
      // Test 2: Get bill transactions
      console.log('📊 Test 2: Getting bill transactions...');
      const transactions = await toyyibpay.getBillTransactions(billResult.data.billCode);
      console.log('📈 Transactions:', transactions);
      
    } else {
      console.error('❌ Failed to create bill:', billResult.error);
    }
  } catch (error) {
    console.error('❌ Error creating bill:', error.message);
  }

  // Test 3: Webhook signature verification
  console.log('\n🔐 Test 3: Testing webhook signature verification...');
  const testWebhookData = {
    refno: 'TEST123',
    billcode: 'abc123',
    status: '1',
    amount: '60.00',
    order_id: 'TEST-ORDER-123',
    signature: '5d41402abc4b2a76b9719d911017c592' // This would be generated by ToyyibPay
  };

  const isValid = toyyibpay.verifyWebhookSignature(testWebhookData);
  console.log('🔍 Signature verification result:', isValid ? '✅ Valid' : '❌ Invalid');
  console.log('💡 Note: This will show Invalid for test data, but validates the verification logic.\n');

  // Test 4: Payment status check
  console.log('💳 Test 4: Testing payment status checks...');
  console.log('Status "1" (Success):', toyyibpay.isPaymentSuccessful('1') ? '✅ Success' : '❌ Not Success');
  console.log('Status "2" (Pending):', toyyibpay.isPaymentSuccessful('2') ? '✅ Success' : '❌ Not Success');
  console.log('Status "3" (Failed):', toyyibpay.isPaymentSuccessful('3') ? '✅ Success' : '❌ Not Success');

  console.log('\n🎉 ToyyibPay integration test completed!');
  console.log('📝 Next steps:');
  console.log('1. Test the payment flow using the generated payment URL');
  console.log('2. Configure webhook URL in ToyyibPay dashboard');
  console.log('3. Test webhook callbacks with real transactions');
}

// Run the test
testToyyibPay().catch(console.error);